(function(){var e=YAHOO.util.Dom,k=YAHOO.util.Event,g=YAHOO.util.Lang,b=YAHOO.util.Element;beCPG.component.AutoCompletePicker=function j(n,m,l){beCPG.component.AutoCompletePicker.superclass.constructor.call(this,"beCPG.component.AutoCompletePicker",n,["button","menu","container"]);YAHOO.Bubbling.on("beforeFormRuntimeInit",this.beforeFormRuntimeInit,this);this.controlId=n;this.fieldHtmlId=m;this.isAssoc=l;return this};YAHOO.extend(beCPG.component.AutoCompletePicker,Alfresco.component.Base);YAHOO.extend(beCPG.component.AutoCompletePicker,Alfresco.component.Base,{objectRenderer:new Alfresco.ObjectRenderer(this),openOnce:false,options:{currentValue:"",mode:"view",readOnly:false,multipleSelectMode:true,targetLinkTemplate:null,dsStr:null,parentFieldHtmlId:null,isMandatory:false,isLocalProxy:false,showToolTip:false,showPage:true,saveTitle:true,urlParamsToPass:null},onReady:function h(){var s=this,p=null,t="";if(s.options.multipleSelectMode||s.isAssoc){s.loadItems()}if(s.options.mode!="view"&&!this.options.readOnly){var r=null,o=null,n=null,m=[],l="";if(this.options.isLocalProxy){r=new YAHOO.util.XHRDataSource(Alfresco.constants.URL_SERVICECONTEXT+s.options.dsStr)}else{r=new YAHOO.util.XHRDataSource(Alfresco.constants.PROXY_URI+s.options.dsStr)}r.responseType=YAHOO.util.XHRDataSource.TYPE_JSON;r.responseSchema={resultsList:"result",fields:["value","name","cssClass","metadatas"],metaFields:{page:"page",pageSize:"pageSize",fullListSize:"fullListSize"}};o=new YAHOO.widget.AutoComplete(s.fieldHtmlId,s.fieldHtmlId+"-container",r);o.queryDelay=0.1;o.page=1;o.maxResultsDisplayed=15;o.forceSelection=false;if(s.options.multipleSelectMode){k.delegate(s.controlId+"-basket","click",function(w,u,q){var v=u.id.split("ac-close-"+s.fieldHtmlId+"-")[1];s.removeFromBasket(v);YAHOO.Bubbling.fire("mandatoryControlValueUpdated",o.getInputEl());k.preventDefault(w);k.stopPropagation(w)},"span.ac-closebutton");k.on(e.get(s.fieldHtmlId).form,"reset",function(u){o._clearSelection();e.get(s.controlId+"-basket").innerHTML="";var w=e.get(s.controlId+"-orig"),v=e.get(s.controlId+"-added"),q=e.get(s.controlId+"-removed");if(w!=null){v.value=w.value}else{v.value=""}q.value=""})}o.generateRequest=function(w){s.openOnce=true;if(s.options.multipleSelectMode&&w.indexOf("%2C%20")>0){var u=w.split("%2C%20");w=u[u.length-1]}var v=null;if(s.options.parentFieldHtmlId!=null){var q=e.get(s.options.parentFieldHtmlId+(s.isAssoc?"-added":""));if(q!=null){v=q.value}}if(v!=null){t=g.substitute("q={query}&parent={parent}&page={page}",{query:w,parent:v,page:o.page})}else{t=g.substitute("q={query}&page={page}",{query:w,page:o.page})}if(s.options.urlParamsToPass!=null){t=t+"&"+s.options.urlParamsToPass}if(s.options.dsStr.indexOf("?")>0){return"&"+t}return"?"+t};o.setHeader("<div class='ac-header' ><span>"+s.msg("autocomplete.header.msg")+"</span></div>");if(s.options.showToolTip){p=new YAHOO.widget.Tooltip("previewTooltip",{container:s.fieldHtmlId+"-container",width:"108px",showDelay:500,zIndex:9999});p.contextTriggerEvent.subscribe(function(w,q){var u=q[0];var v=u.id.split("ac-choice-"+s.fieldHtmlId+"-")[1].replace(":/","");this.cfg.setProperty("text",'<img src="'+Alfresco.constants.PROXY_URI_RELATIVE+"api/node/"+v+'/content/thumbnails/doclib?c=queue&ph=true" />')})}o.formatResult=function(u,v,q){if(s.options.showToolTip){m.push("ac-choice-"+s.fieldHtmlId+"-"+u[0])}return"<span id='ac-choice-"+s.fieldHtmlId+"-"+u[0]+"' class='"+u[2]+"'  >"+u[1]+"</span>"};n=e.get(s.fieldHtmlId+"-toggle-autocomplete");k.on(s.fieldHtmlId+"-autocomplete","click",function(q){if(!o.isContainerOpen()){o.getInputEl().focus()}});k.on(n,"click",function(q){if(o.isContainerOpen()){o.collapseContainer()}else{o.getInputEl().focus();l=o.getInputEl().value;setTimeout(function(){o.sendQuery("*")},0)}o.page=1;m=[];k.preventDefault(q);k.stopPropagation(q)});o.containerExpandEvent.subscribe(function(){e.addClass(n,"openToggle")});o.containerCollapseEvent.subscribe(function(){e.removeClass(n,"openToggle");o.page=1;m=[]});o.doBeforeLoadData=function(v,q,u){if(s.options.showPage){o.fullListSize=q.meta.fullListSize;o.pageSize=q.meta.pageSize;o.page=q.meta.page}return true};o.doBeforeExpandContainer=function(x,u,w,v){if(!s.options.showPage||parseInt(o.fullListSize)<parseInt(o.pageSize)+1){o.setFooter("")}else{o.setFooter("<div class='ac-footer'><div id='"+s.fieldHtmlId+"-container-paging'></div></div>");var q=new YAHOO.widget.Paginator({rowsPerPage:o.pageSize,totalRecords:o.fullListSize,containers:s.fieldHtmlId+"-container-paging",initialPage:parseInt(o.page),template:"<div>{CurrentPageReport}</div> {PreviousPageLink} {PageLinks} {NextPageLink}",pageReportTemplate:s.msg("autocomplete.pagination.template.page-report"),previousPageLinkLabel:s.msg("autocomplete.pagination.previousPageLinkLabel"),nextPageLinkLabel:s.msg("autocomplete.pagination.nextPageLinkLabel")});q.subscribe("changeRequest",function(y){o.page=y.page;m=[];setTimeout(function(){var z=o.getInputEl().value;if(z==l){o.sendQuery("*")}else{o.sendQuery(z)}},0)});q.render()}if(s.options.showToolTip&&p!=null){p.cfg.setProperty("context",m)}return true};o.textboxKeyEvent.subscribe(function(){o.page=1;m=[]});o.textboxBlurEvent.subscribe(function(){if(s.openOnce&&(!o._bOverContainer||(o._nKeyCode==9))){if(!o._bItemSelected){var u=o._textMatchesOption();if(!o._bContainerOpen||(o._bContainerOpen&&(u===null))){o._clearSelection()}}}if(!s.options.multipleSelectMode&&s.isAssoc){if(o.getInputEl().value==null||o.getInputEl().value.length<1){var w=e.get(s.controlId+"-orig"),v=e.get(s.controlId+"-added"),q=e.get(s.controlId+"-removed");if(w!=null&&w.value!=""){q.value=w.value}v.value=""}}});o.itemSelectEvent.subscribe(function(x,v){var w=v[2],z=w[0],q=w[1];if(s.isAssoc||s.options.multipleSelectMode){var y=e.get(s.controlId+"-added");if(!s.options.multipleSelectMode){var A=e.get(s.controlId+"-orig"),u=e.get(s.controlId+"-removed");if(A!=null){if(A.value!=z){if(A.value!=""){u.value=A.value}y.value=z}else{u.value="";y.value=""}}else{y.value=z}}else{if(y.value!=""){y.value+=","}y.value+=z}}if(s.options.multipleSelectMode){s.addToBasket(e.get(s.controlId+"-basket"),q,z);o.getInputEl().value=""}else{if(s.options.saveTitle){o.getInputEl().value=q}else{o.getInputEl().value=z}}YAHOO.Bubbling.fire("mandatoryControlValueUpdated",o.getInputEl());return true});e.removeClass(o.getInputEl(),"hidden")}else{if(!s.options.multipleSelectMode&&!s.isAssoc){e.removeClass(s.fieldHtmlId+"-values","hidden")}}},addToBasket:function f(n,l,o){var m="<span id='ac-m-selected-"+this.fieldHtmlId+"-"+o+"' class='ac-m-selected'><span class='ac-m-selected-body'>";m+=l;m+="</span>";m+="<span id='ac-close-"+this.fieldHtmlId+"-"+o+"' class='ac-closebutton' ></span>";m+="</span>";n.innerHTML+=m},removeFromBasket:function i(m){var n=new b(this.controlId+"-basket"),o=e.get(this.controlId+"-added");n.removeChild(e.get("ac-m-selected-"+this.fieldHtmlId+"-"+m));if(this.isAssoc&&e.get(this.controlId+"-removed")){var l=e.get(this.controlId+"-removed");if(l.value!=""){l.value+=","}l.value+=m}if(o){o.value=o.value.replace(","+m,"").replace(m+",","").replace(m,"")}},loadItems:function d(){var o=this;if(o.options.currentValue!=""){if(o.isAssoc){Alfresco.util.Ajax.jsonRequest({url:Alfresco.constants.PROXY_URI+"api/forms/picker/items",method:"POST",dataObj:{items:o.options.currentValue.split(",")},successCallback:{fn:function(s){var r=s.json.data.items,u={};for(var t=0,q=r.length;t<q;t++){u[r[t].nodeRef]=r[t]}o.renderItems(u)},scope:this}})}else{var m=o.options.currentValue.split(",");for(var n=0,l=m.length;n<l;n++){var p=e.get(o.controlId+"-basket");o.addToBasket(p,m[n],m[n])}}}},renderItems:function a(l){var n="",p;if(l===null){n='<span class="error">'+this.msg("form.control.object-picker.current.failure")+"</span>"}else{if(this.options.mode=="view"||this.options.readOnly){for(var m in l){var o=l[m];if(n!=""){n+=", "}if(this.options.targetLinkTemplate!=null){p=Alfresco.util.siteURL(g.substitute(this.options.targetLinkTemplate,o),{site:o.site});n+=this.objectRenderer.renderItem(o,16,"<div>{icon} <a href='"+p+"'>{name}</a></div>")}else{n+=o.name}}e.get(this.fieldHtmlId+"-values").innerHTML=n;e.removeClass(this.fieldHtmlId+"-values","hidden")}else{if(this.options.multipleSelectMode){var q=e.get(this.controlId+"-basket");for(var m in l){var o=l[m];this.addToBasket(q,o.name,o.nodeRef)}}else{var r=e.get(this.fieldHtmlId);for(var m in l){var o=l[m];n+=o.name}r.value=n;YAHOO.Bubbling.fire("mandatoryControlValueUpdated",r);e.removeClass(this.fieldHtmlId,"hidden")}}}},getValues:function c(){var n=this,p=e.get(n.controlId+"-added");inputOrig=e.get(n.controlId+"-orig"),inputRemoved=e.get(n.controlId+"-removed"),orig=[],removed=[],ret=[];if(p!=null&&p.value.length>0){ret=p.value.split(",")}if(inputOrig!=null&&inputOrig.value.length>0){orig=inputOrig.value.split(",")}if(inputRemoved!=null&&inputRemoved.value.length>0){removed=inputRemoved.value.split(",")}for(var m in orig){var o=true;for(var l in removed){if(orig[m]==removed[l]){o=false;break}}if(o){ret.push(orig[m])}}return ret.join()},beforeFormRuntimeInit:function(n,m){var o=this,p=m[1].runtime;if(this.options.multipleSelectMode&&this.fieldHtmlId.indexOf(p.formId.replace("-form",""))>-1){for(var l=0;l<m[1].runtime.validations.length;l++){if(m[1].runtime.validations[l].fieldId==this.fieldHtmlId){m[1].runtime.validations[l].handler=function q(v,s,u,t){var r=o.getValues();return YAHOO.lang.trim(r).length!==0}}}}},})})();