(function(){var b=YAHOO.util.Dom;beCPG.component.VariantPicker=function(d){beCPG.component.VariantPicker.superclass.constructor.call(this,"beCPG.component.VariantPicker",d,["button","container"]);this.name="beCPG.component.EntityDataListToolbar";return this};YAHOO.extend(beCPG.component.VariantPicker,Alfresco.component.Base);YAHOO.lang.augmentObject(beCPG.component.VariantPicker.prototype,{options:{entityNodeRef:"",entity:null,containerDiv:null,toolBarInstance:null,formWidth:"34em"},currentVariantNodeRef:null,onReady:function a(){var e=[{text:'<span class="variant-all">'+this.msg("picker.variant.all")+"</span>",value:"all",onclick:{fn:this.onMenuItemClick,scope:this}},{text:'<span class="variant-common">'+this.msg("picker.variant.common")+"</span>",value:"common",onclick:{fn:this.onMenuItemClick,scope:this}}];for(var d in this.options.entity.variants){var f='<span class="variant'+(this.options.entity.variants[d].isDefaultVariant?"-default":"")+'">'+this.options.entity.variants[d].name+"</span>";e.push({text:f,value:this.options.entity.variants[d].nodeRef,onclick:{fn:this.onMenuItemClick,scope:this}})}this.widgets.variantPicker=new YAHOO.widget.Button({type:"split",label:this.msg("picker.variant.choose"),name:"mymenubutton",menu:e,container:this.options.containerDiv,lazyloadmenu:false});this.widgets.createVariantButton=this.createYUIButton(this,"create-variant",this.onCreateVariant);this.widgets.editVariantButton=this.createYUIButton(this,"edit-variant",this.onEditVariant);this.widgets.deleteVariantButton=this.createYUIButton(this,"delete-variant",this.onDeleteVariant);b.setStyle(this.widgets.editVariantButton,"display","none");b.setStyle(this.widgets.deleteVariantButton,"display","none")},createYUIButton:function(e,f,i){var h=b.get(this.options.toolBarInstance.id+"-toolBar-template-button"),g=null;var d=b.getFirstChild(h).cloneNode(true);b.addClass(d,f);b.setAttribute(d,"id",this.id+"-"+f+"Button");this.options.containerDiv.appendChild(d);g=Alfresco.util.createYUIButton(this,f+"Button",i);g.set("label",this.msg("button."+f));g.set("title",this.msg("button."+f+".description"));return g},onMenuItemClick:function(f,e,d){if(d){var g=d.cfg.getProperty("text"),h=d.value;this.widgets.variantPicker.set("label",g);if("all"===h||"common"===h){this.currentVariantNodeRef=null;b.setStyle(this.widgets.createVariantButton,"display","");b.setStyle(this.widgets.editVariantButton,"display","none");b.setStyle(this.widgets.deleteVariantButton,"display","none");if("all"===d.value){YAHOO.Bubbling.fire("changeFilter",{filterOwner:this.id,filterId:"all"})}else{if("common"===d.value){YAHOO.Bubbling.fire("changeFilter",{filterOwner:this.id,filterId:"fts",filterData:"ISNULL:bcpg\\:variantIds OR ISUNSET:bcpg\\:variantIds"})}}}else{YAHOO.Bubbling.fire("changeFilter",{filterOwner:this.id,filterId:"fts",filterData:'@bcpg\\:variantIds:"'+d.value+'" OR ISNULL:bcpg\\:variantIds OR ISUNSET:bcpg\\:variantIds'});this.currentVariantNodeRef=d.value;b.setStyle(this.widgets.createVariantButton,"display","none");b.setStyle(this.widgets.editVariantButton,"display","");b.setStyle(this.widgets.deleteVariantButton,"display","")}}},onCreateVariant:function c(){var e=this;var f=function(j,k){Alfresco.util.populateHTML([k.id+"-dialogTitle",e.msg("label.new-variant.title")])};var i=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?itemKind={itemKind}&itemId={itemId}&destination={destination}&association={association}&mode={mode}&submitType={submitType}&showCancelButton=true&popup=true",{itemKind:"type",itemId:"bcpg:variant",destination:e.options.entityNodeRef,association:"bcpg:variants",mode:"create",submitType:"json"});var h=new Alfresco.module.SimpleDialog(e.id+"-createVariant");h.setOptions({width:e.options.formWidth,templateUrl:i,actionUrl:null,destroyOnHide:true,doBeforeDialogShow:{fn:f,scope:this},onSuccess:{fn:function d(j){Alfresco.util.Ajax.jsonRequest({url:Alfresco.constants.PROXY_URI+"api/forms/picker/items",method:"POST",dataObj:{items:[j.json.persistedObject]},successCallback:{fn:function(o){var l=o.json.data.items,n=[];for(var m=0,k=l.length;m<k;m++){n.push({text:l[m].name,value:l[m].nodeRef,onclick:{fn:e.onMenuItemClick,scope:e}})}e.widgets.variantPicker.getMenu().addItems(n);Alfresco.util.PopupManager.displayMessage({text:e.msg("message.create-variant.success")})},scope:e}})},scope:this},onFailure:{fn:function g(j){Alfresco.util.PopupManager.displayMessage({text:e.msg("message.create-variant.failure")})},scope:this}}).show()},onEditVariant:function c(){var d=this;if(d.currentVariantNodeRef){var f=function(h,i){Alfresco.util.populateHTML([i.id+"-dialogTitle",d.msg("label.edit-variant.title")])};var g=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?itemKind={itemKind}&itemId={itemId}&mode={mode}&submitType={submitType}&showCancelButton=true&popup=true",{itemKind:"node",itemId:d.currentVariantNodeRef,mode:"edit",submitType:"json"});var e=new Alfresco.module.SimpleDialog(d.id+"-editVariant");e.setOptions({width:d.options.formWidth,templateUrl:g,actionUrl:null,destroyOnHide:true,doBeforeDialogShow:{fn:f,scope:this},onSuccess:{fn:function(h){Alfresco.util.Ajax.jsonRequest({url:Alfresco.constants.PROXY_URI+"api/forms/picker/items",method:"POST",dataObj:{items:[h.json.persistedObject]},successCallback:{fn:function(o){var k=o.json.data.items,n=d.widgets.variantPicker.getMenu().getItems();for(var m=0,j=k.length;m<j;m++){for(var l in n){if(n.hasOwnProperty(l)){if(n[l].value===k[m].nodeRef){d.widgets.variantPicker.getMenu().removeItem(n[l]);d.widgets.variantPicker.getMenu().addItem({text:k[m].name,value:k[m].nodeRef,onclick:{fn:d.onMenuItemClick,scope:d}});d.widgets.variantPicker.set("label",k[m].name)}}}}d.widgets.variantPicker.getMenu().addItems(n);Alfresco.util.PopupManager.displayMessage({text:d.msg("message.edit-variant.success")})},scope:d}})},scope:this},onFailure:{fn:function(h){Alfresco.util.PopupManager.displayMessage({text:d.msg("message.edit-variant.failure")})},scope:this}}).show()}},onDeleteVariant:function c(){var d=this,f=[d.currentVariantNodeRef];if(d.currentVariantNodeRef){var e=function(g){Alfresco.util.Ajax.jsonRequest({url:Alfresco.constants.PROXY_URI+"slingshot/datalists/action/items?alf_method=delete",method:"POST",dataObj:{nodeRefs:g},successCallback:{fn:function(j){var m=d.widgets.variantPicker.getMenu().getItems();for(var l=0,h=g.length;l<h;l++){for(var k in m){if(m.hasOwnProperty(k)){if(m[k].value===g[l]){d.widgets.variantPicker.getMenu().removeItem(m[k]);break}}d.widgets.variantPicker.set("label",d.msg("picker.variant.choose"));b.setStyle(d.widgets.createVariantButton,"display","");b.setStyle(d.widgets.editVariantButton,"display","none");b.setStyle(d.widgets.deleteVariantButton,"display","none")}}Alfresco.util.PopupManager.displayMessage({text:d.msg("message.delete-variant.success")})},scope:d}})};Alfresco.util.PopupManager.displayPrompt({title:d.msg("message.confirm.delete.title",f.length),text:d.msg("message.confirm.delete.description",f.length),buttons:[{text:d.msg("button.delete"),handler:function(){this.destroy();e.call(d,f)}},{text:d.msg("button.cancel"),handler:function(){this.destroy()},isDefault:true}]})}}},true)})();