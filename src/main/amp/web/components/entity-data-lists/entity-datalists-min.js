(function(){var f=YAHOO.util.Dom,i=YAHOO.util.Event,b=YAHOO.Bubbling;var d=Alfresco.util.encodeHTML,e=Alfresco.util.combinePaths;beCPG.component.EntityDataLists=function(j){return beCPG.component.EntityDataLists.superclass.constructor.call(this,j)};YAHOO.extend(beCPG.component.EntityDataLists,Alfresco.component.DataLists,{entity:null,options:{entityNodeRef:"",listId:"",listTypes:[],sortOptions:[]},onReady:function h(){this.widgets.spinner=new YAHOO.widget.Panel(this.id+"-waitPanel",{width:"240px",fixedcenter:true,close:false,draggable:false,zindex:99,modal:true,visible:false});this.widgets.spinner.setHeader(this.msg("message.loading"));this.widgets.spinner.setBody('<div style="text-align:center;"><img src="'+Alfresco.constants.URL_RESCONTEXT+'/components/images/rel_interstitial_loading.gif" /></div>');this.widgets.spinner.render(document.body);this.widgets.newList=Alfresco.util.createYUIButton(this,"newListButton",this.onNewList,{disabled:true});this.populateDataLists({fn:function j(){this.renderDataLists();if(this.options.listId.length>0&&this.dataLists[this.options.listId]){YAHOO.Bubbling.fire("activeDataListChanged",{list:this.options.listId,dataList:this.dataLists[this.options.listId],entity:this.entity,scrollTo:true})}else{YAHOO.Bubbling.fire("hideFilter")}if(this.dataListsLength===0||window.location.hash==="#new"){this.widgets.newList.fireEvent("click")}},scope:this})},populateDataLists:function c(k){if(document.referrer===null||document.referrer.indexOf("entity-data-lists")<1){this.showLoadingAjaxSpinner(true)}var l=function m(p,u){this.showLoadingAjaxSpinner(false);var o=p.json.datalists,t,s=this;if(p.json.listTypes){this.options.listTypes=p.json.listTypes}this.dataLists={};if(p.json.container){this.containerNodeRef=new Alfresco.util.NodeRef(p.json.container)}else{this.containerNodeRef=new Alfresco.util.NodeRef(this.options.entityNodeRef)}this.entity=p.json.entity;this.widgets.newList.set("disabled",!p.json.permissions.create);if(this.options.sortOptions!=null&&this.options.sortOptions.length>0){o.sort(function(y,w){var x=500,v=500;for(var A in s.options.sortOptions){if(y.name.indexOf(s.options.sortOptions[A].id)>-1){x=s.options.sortOptions[A].sortIndex}if(w.name.indexOf(s.options.sortOptions[A].id)>-1){v=s.options.sortOptions[A].sortIndex}}return x-v})}for(var q=0,r=o.length;q<r;q++){t=o[q];this.dataLists[t.name]=t}this.dataListsLength=o.length;if(k&&(typeof k.fn=="function")){k.fn.call(k.scope||this,k.obj)}};var n=function j(o){this.showLoadingAjaxSpinner(false);if(o.status==401){window.location.reload()}else{this.dataLists=null;this.containerNodeRef=null;this.widgets.newList.set("disabled",true);var p="";try{p=d(YAHOO.lang.JSON.parse(o.responseText).message)}catch(q){p=this.msg("message.error-unknown")}Alfresco.util.PopupManager.displayMessage({text:p})}};Alfresco.util.Ajax.jsonGet({url:e(Alfresco.constants.PROXY_URI,"becpg/entitylists/node",this.options.entityNodeRef.replace(":/","")),successCallback:{fn:l,obj:k,scope:this},failureCallback:{fn:n,scope:this}})},showLoadingAjaxSpinner:function(j){if(j){this.widgets.spinner.show()}else{this.widgets.spinner.hide()}},renderDataLists:function a(p){var G=this,E=f.get(this.id+"-lists"),q="selected";E.innerHTML="";var o=function m(){return function z(){var H=Selector.query("li",E);f.removeClass(H,q);f.addClass(this,q);return true}};var A=function j(H,z){return function I(J){if(z){G.onEditList(H)}i.stopEvent(J||window.event)}};var l=function t(H,z){return function I(J){if(z){G.onDeleteList(H)}i.stopEvent(J||window.event)}};try{var F=this.dataLists,D,s,u=null,v,k,C,y,w,x;if(this.dataListsLength===0){E.innerHTML='<div class="no-lists">'+this.msg("message.no-lists")+"</div>"}else{v=document.createElement("ul");E.appendChild(v);for(var n in F){if(F.hasOwnProperty(n)){D=F[n];if(this.options.listId===null||this.options.listId.length<1){this.options.listId=D.name;if(this.options.sortOptions!=null&&this.options.sortOptions.length>0){for(var r in this.options.sortOptions){if(D.name.indexOf(this.options.sortOptions[r].id)>-1){if(this.options.sortOptions[r].isView){window.location.href="entity-data-lists?list="+d(D.name)+"&nodeRef="+d(this.options.entityNodeRef)}break}}}}s=D.permissions;k=document.createElement("li");k.onclick=o();C=document.createElement("span");if(s.edit){C.className="edit";C.title=this.msg("label.edit-list");C.onclick=A(D.name,true)}else{C.className="edit-disabled";C.onclick=A(D.name,false)}y=document.createElement("span");if(s["delete"]){y.className="delete";y.title=this.msg("label.delete-list");y.onclick=l(D.name,true)}else{y.className="delete-disabled";y.onclick=l(D.name,false)}w=document.createElement("a");w.title=D.description;w.href="entity-data-lists?list="+d(D.name)+"&nodeRef="+d(this.options.entityNodeRef);if(D.name.indexOf("WUsed")>-1){w.className="WUsed"}else{w.className=D.name}if(D.state&&D.state.length>0){w.className+=" "+D.state}x=document.createTextNode(D.title);w.appendChild(y);w.appendChild(C);w.appendChild(x);k.appendChild(w);v.appendChild(k);if(D.name==this.options.listId){f.addClass(k,"selected")}if(D.name==p){u=k}}}if(u){Alfresco.util.Anim.pulse(u)}}}catch(B){E.innerHTML='<span class="error">'+this.msg("message.error-unknown")+"</span>"}},onNewList:function g(p,u){var t=this.containerNodeRef.nodeRef,k="theme-bg-selected",s=this;var r=function l(y,E,x){var C=function F(H,I){return function G(){var M=Selector.query("div",y);f.removeClass(M,k);f.addClass(H,k);if("WUsedList"==I){var L=f.get(E);var J=document.createElement("label");J.id=s.id+"-wUsedLabel";J.innerHTML='<label  for="'+E+'">'+s.msg("label.wused.type.header")+'<span class="mandatory-indicator">*</span></label>';f.insertBefore(J,L);var N=document.createElement("div");N.id=s.id+"-wUsedName";N.className="form-field";N.innerHTML='<label for="'+s.id+'-prop_cm_name">'+s.msg("label.wused.name")+':<span class="mandatory-indicator">*</span> </label><input type="text"  name="prop_cm_name" id="'+s.id+'-prop_cm_name" value="WUsed-" class="mandatory" >';L.type="text";L.value="";f.insertAfter(N,L.parentNode)}else{var K=document.getElementById(s.id+"-wUsedLabel");if(K){K.parentNode.removeChild(K)}K=document.getElementById(s.id+"-wUsedName");if(K){K.parentNode.removeChild(K)}f.get(E).type="hidden";f.get(E).value=I}x.validate();return false}};var B,w,A=f.get(y);for(var z=0,D=this.options.listTypes.length;z<D;z++){B=this.options.listTypes[z];w=document.createElement("div");w.innerHTML="<h4>"+d(B.title)+"</h4><span>"+d(B.description)+"</span>";w.onclick=C(w,B.name);A.appendChild(w)}};var v=function q(w,z){Alfresco.util.populateHTML([z.id+"-dialogTitle",this.msg("label.new-list.title")],[z.id+"-dialogHeader",this.msg("label.new-list.header")],[z.id+"-dataListItemType",this.msg("label.item-type")]);r.apply(this,[z.id+"-itemTypesContainer",z.id+"-dataListItemType-field",w]);var y=function x(F,B,E,D,A,C){return(F.value.length>0)};w.addValidation(z.id+"-dataListItemType-field",y,null,null,null,{validationType:"mandatory"})};var m=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?itemKind={itemKind}&itemId={itemId}&destination={destination}&mode={mode}&submitType={submitType}&showCancelButton=true",{itemKind:"type",itemId:"dl:dataList",destination:t,mode:"create",submitType:"json"});var n=new Alfresco.module.SimpleDialog(this.id+"-newList");n.setOptions({width:"33em",templateUrl:m,actionUrl:null,destroyOnHide:true,doBeforeDialogShow:{fn:v,scope:this},onSuccess:{fn:function j(w){var z=new Alfresco.util.NodeRef(w.json.persistedObject),x=w.config.dataObj.prop_cm_title,y=this.getListTypeTitle(w.config.dataObj.prop_dl_dataListItemType);b.fire("dataListCreated");Alfresco.util.PopupManager.displayMessage({text:this.msg("message.new-list.success",x)});Alfresco.Share.postActivity(this.options.siteId,"org.alfresco.datalists.list-created",x+" ("+y+")","data-lists?list={cm:name}",{appTool:"datalists",nodeRef:z.toString()})},scope:this},onFailure:{fn:function o(w){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.new-list.failure")})},scope:this}}).show()}})})();