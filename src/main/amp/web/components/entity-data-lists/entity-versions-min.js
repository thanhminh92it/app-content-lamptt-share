(function(){var f=YAHOO.util.Dom,k=YAHOO.util.Event;var e=Alfresco.util.encodeHTML;beCPG.component.EntityVersions=function j(p){beCPG.component.EntityVersions.superclass.constructor.call(this,"beCPG.component.EntityVersions",p,["datasource","datatable","paginator","history","animation"]);return this};YAHOO.extend(beCPG.component.EntityVersions,Alfresco.component.Base,{options:{nodeRef:null,siteId:""},versions:[],earliestVersion:{},latestVersion:null,versionCache:null,onReady:function o(){var q=f.get(this.id+"-branches");if(!q){return}var p=this;this.widgets.alfrescoDataTable=new Alfresco.util.DataTable({dataSource:{url:Alfresco.constants.PROXY_URI+"becpg/api/entity-version?mode=branches&nodeRef="+this.options.nodeRef,doBeforeParseData:this.bind(function(s,r){p.latestVersion=r.versions.splice(0,1)[0];p.versionCache=r.versions;if(!p.widgets.versionMenu){p.createMenu();var t=f.getElementsByClassName("version-historic-nav","a",p.id);k.addListener(t[0],"click",p.onNavButtonClick,p,true);k.addListener(t[1],"click",p.onNavButtonClick,p,true);p.updateNavState();f.removeClass(this.id+"-body","hidden")}return({data:r.branches})})},dataTable:{container:this.id+"-branches",columnDefinitions:[{key:"version",sortable:false,formatter:this.bind(this.renderCellVersion)}],config:{MSG_EMPTY:this.msg("message.noVersions")}}})},renderCellVersion:function n(q,p,r,s){q.innerHTML=this.getDocumentVersionMarkup(p.getData())},getDocumentVersionMarkup:function g(s){var q=Alfresco.constants.PROXY_URI+"becpg/entity/compare/"+this.options.nodeRef.replace(":/","")+"/compare.pdf?entities="+s.nodeRef,p="",r=(this.options.nodeRef==s.nodeRef);p+='<div class="entity-branches">';p+='   <span class="document-version">'+e(s.label)+"</span>";p+='   <span class="'+s.metadata+(r?" current":"")+'" ><a title="'+s.description+'" href="'+beCPG.util.entityCharactURL(s.siteId,s.nodeRef,s.itemType)+'">'+e(s.name)+"</a></span>";if(!r){p+='   <span class="actions"><a href="'+q+'" class="compare" title="'+this.msg("label.compare")+'">&nbsp;</a></span>'}else{p+='  <span class="actions"><a href="#" name=".onVersionsGraphClick" rel="'+this.options.nodeRef+'" class="'+this.id+' versions-graph" title="'+this.msg("label.versionsGraph")+'">&nbsp;</a></span>'}p+="</div>";return p},onVersionMenuChange:function d(t,s,r){var q=s[1],p=q.value;this.update(p)},update:function i(p){if(p){this.options.nodeRef=p;var q={filterId:"all"};if(this.latestVersion.nodeRef!=p){q={filterOwner:"beCPG.component.EntityVersions",filterId:"version",filterData:p}}YAHOO.Bubbling.fire("versionChangeFilter",q);this.setMenuTitle();this.updateNavState()}},updateNavState:function l(){var p=f.getElementsByClassName("version-historic-nav","a",this.id+"-body");f.removeClass(p,"disabled");if(this.options.nodeRef===this.earliestVersion.nodeRef){f.addClass(p[0],"disabled")}else{if(this.options.nodeRef===this.latestVersion.nodeRef){f.addClass(p[1],"disabled")}}},createMenu:function c(){var r=f.get(this.id+"-versionNav-menu"),z=f.getElementsByClassName("nav","div",f.get(this.id+"-body"))[0],s=document.createElement("h6"),w=document.createElement("h6"),y=Alfresco.util.message("version-historic.menu.title",this.name,{"0":this.latestVersion.label}),p=[];p.push({value:this.latestVersion.nodeRef,text:y});for(var t in this.versionCache){var v=this.versionCache[t],x=Alfresco.util.message("version-historic.menu.title",this.name,{"0":v.label});if(parseInt(t,10)===this.versionCache.length-1){this.earliestVersion=v}p.push({value:v.nodeRef,text:x})}for(var t=0;t<p.length;t++){var u=document.createElement("option");u.text=p[t].text;u.value=p[t].value;r.add(u)}this.widgets.versionMenu=new Alfresco.util.createYUIButton(this,"versionNav-button",this.onVersionMenuChange,{type:"menu",menu:r,lazyloadmenu:false});this.setMenuTitle(y);var A=f.getElementsByClassName("first-of-type","ul",z)[0],q=f.getElementsByClassName("first-of-type","li",A)[0];s.innerHTML=Alfresco.util.message("version-historic.menu.current",this.name);w.innerHTML=Alfresco.util.message("version-historic.menu.previous",this.name);f.insertBefore(s,q);f.insertAfter(w,q)},getVersionNodeRef:function a(r){var t=this.options.nodeRef,u,q,p=null;q=-1;for(var s in this.versionCache){if(this.versionCache[s].nodeRef===t){q=s}if(this.versionCache[s].label===r){p=s}}if(r===this.latestVersion.label){return this.latestVersion.nodeRef}else{if(r==="next"){p=parseInt(q,10)-1}else{if(r==="previous"){p=parseInt(q,10)+1}}}if(p===-1){return this.latestVersion.nodeRef}returnVersion=this.versionCache[p];if(typeof(returnVersion)!=="undefined"){u=returnVersion.nodeRef;return u}},onNavButtonClick:function h(r,t){var s=k.getTarget(r),q=s.rel,p=this.getVersionNodeRef(q);if(!f.hasClass(s,"disabled")){this.update(p)}k.preventDefault(r)},setMenuTitle:function m(r){var p="",q=null;if(!r){if(this.options.nodeRef===this.latestVersion.nodeRef){p=this.latestVersion.label;title=Alfresco.util.message("version-historic.menu.title.latest",this.name,{"0":p})}else{for(q in this.versionCache){if(this.versionCache[q].nodeRef===this.options.nodeRef){p=this.versionCache[q].label}}title=Alfresco.util.message("version-historic.menu.title",this.name,{"0":p})}}else{title=r}this.widgets.versionMenu.set("label",title)},onVersionsGraphClick:function b(p){beCPG.module.getVersionsGraphInstance().show({nodeRef:p})},})})();