(function(){var i=YAHOO.util.Dom;var h=Alfresco.util.encodeHTML;var a=Alfresco.util.generateDomId(null,"show-more-twister");beCPG.component.EntityProjects=function g(p){return beCPG.component.EntityProjects.superclass.constructor.call(this,p)};YAHOO.extend(beCPG.component.EntityProjects,Alfresco.component.SimpleDocList,{queryExecutionId:null,onReady:function d(){var s=this;this.widgets.dataSource=new YAHOO.util.DataSource(this.getWebscriptUrl(),{connMethodPost:true,responseType:YAHOO.util.DataSource.TYPE_JSON,responseSchema:{resultsList:"items",metaFields:{startIndex:"startIndex",totalRecords:"totalRecords",queryExecutionId:"queryExecutionId"}}});this.widgets.dataSource.connMgr.setDefaultPostHeader(Alfresco.util.Ajax.JSON);var u=[{key:"thumbnail",sortable:false,formatter:this.bind(this.renderCellThumbnail),width:16},{key:"detail",sortable:false,formatter:this.bind(this.renderCellDetail)}];this.widgets.alfrescoDataTable=new YAHOO.widget.DataTable(this.id+"-documents",u,this.widgets.dataSource,{initialLoad:false,dynamicData:false,MSG_EMPTY:'<span class="wait">'+h(this.msg("message.loading"))+"</span>",MSG_ERROR:this.msg("message.error"),className:"alfresco-datatable simple-doclist",renderLoopSize:4,paginator:null,});this.widgets.alfrescoDataTable.getDataTable=function(){return this};this.widgets.alfrescoDataTable.getData=function(v){return this.getRecord(v).getData()};this.widgets.alfrescoDataTable.loadDataTable=function q(w){s.widgets.dataSource.connMgr.setDefaultPostHeader(Alfresco.util.Ajax.JSON);var x=w;if(!x){x=scopeParameters}if(Alfresco.util.CSRFPolicy.isFilterEnabled()){s.widgets.dataSource.connMgr.initHeader(Alfresco.util.CSRFPolicy.getHeader(),Alfresco.util.CSRFPolicy.getToken(),false)}s.widgets.dataSource.sendRequest(YAHOO.lang.JSON.stringify(x),{success:function v(z,y,A){s.widgets.alfrescoDataTable.onDataReturnReplaceRows(z,y,A);if(s.widgets.paginator){s.widgets.paginator.set("totalRecords",y.meta.totalRecords);s.widgets.paginator.setPage(y.meta.startIndex,true)}s.queryExecutionId=y.meta.queryExecutionId},failure:s.widgets.alfrescoDataTable.onDataReturnReplaceRows,scope:s.widgets.alfrescoDataTable,argument:{}})};var t=this.widgets.alfrescoDataTable,r=t.doBeforeLoadData;t.doBeforeLoadData=function p(v,w,x){if(w.results&&w.results.length===0){w.results.unshift({isInfo:true,title:s.msg("empty.project.title"),description:s.msg("empty.project.description")})}return r.apply(this,arguments)};YAHOO.Bubbling.addDefaultAction(a,this.onActionShowMore);this.initTaskHandlers();this.reloadDataTable()},getWebscriptUrl:function e(){return Alfresco.constants.PROXY_URI+"becpg/entity/datalists/data/node?itemType=pjt:project&pageSize="+this.options.maxItems+"&entityNodeRef="+this.options.nodeRef+"&dataListName=projectList&repo=true"},getParameters:function l(){var p={project:["pjt_projectOverdue","pjt_projectHierarchy1","pjt_projectHierarchy2","pjt_projectPriority","pjt_completionPercent","bcpg_code","cm_name","pjt_taskList|pjt_tlTaskName|pjt_tlDuration|pjt_tlPrevTasks|pjt_tlState|pjt_completionPercent|pjt_tlStart|pjt_tlEnd|pjt_tlWorkflowInstance|fm_commentCount","pjt_deliverableList|pjt_dlDescription|pjt_dlContent|pjt_dlState|fm_commentCount","pjt_projectManager","pjt_projectStartDate","pjt_projectCompletionDate","pjt_projectDueDate","pjt_projectState"]};var q={fields:p.project,page:1,sort:"cm:name",queryExecutionId:this.queryExecutionId,filter:{filterId:"entity-projects",filterOwner:"Alfresco.component.AllFilter",filterData:"InProgress"}};return q},renderCellThumbnail:function o(x,A,u,p){var q=90,s=A.getData(),t="";if(s.isInfo){q=52;t='<img src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/help-docs-bw-32.png" />'}else{s.jsNode={};s.jsNode.type=s.itemType;var r=s.itemData.prop_cm_name.value,z=s.site!=null?s.site.shortName:null,v=r.substring(r.lastIndexOf(".")),w=new Alfresco.util.NodeRef(s.nodeRef),y=beCPG.util.entityDetailsURL(z,s.nodeRef,s.itemType);t='<span class="thumbnail" ><a href="'+y+'"><img width="90%" height="90%"  src="'+Alfresco.constants.PROXY_URI+"api/node/"+w.uri+'/content/thumbnails/doclib?c=queue&ph=true" alt="'+v+'" title="'+h(r)+'" /></a></span>'}u.width=q;i.setStyle(x,"width",u.width+"px");i.setStyle(x.parentNode,"width",u.width+"px");x.innerHTML=t},renderCellDetail:function k(w,x,u,q){var s=x.getData(),t="",v="";if(s.isInfo){t+='<div class="empty"><h3>'+s.title+"</h3>";t+="<span>"+s.description+"</span></div>"}else{var p=this.extractDates(s,null,false),r=p.due;v+=(p.start?Alfresco.util.formatDate(p.start,"longDate"):scope.msg("label.none"));if(p.end!=null){r=p.end}v+=" - ";v+=(p.start?Alfresco.util.formatDate(r,"longDate"):scope.msg("label.none"));t+='<h3 class="filename">'+this.getProjectTitle(s,true,true)+"</h3>";t+=this.renderProjectManager(x);t+='<div class="detail">';t+='<span class="project-date">[ '+v+" ]</span><br/>";t+='<span class="hierachy">';if(s.itemData.prop_pjt_projectHierarchy1&&s.itemData.prop_pjt_projectHierarchy1.displayValue!=null){t+=s.itemData.prop_pjt_projectHierarchy1.displayValue}if(s.itemData.prop_pjt_projectHierarchy2&&s.itemData.prop_pjt_projectHierarchy2.displayValue!=null){t+=" - "+s.itemData.prop_pjt_projectHierarchy2.displayValue}t+="</span>";t+=this.renderTaskList(x);t+=this.renderDeliverableList(x);t+="</div>"}w.innerHTML=t},onActionShowMore:function b(r,q){var p=q[1].anchor;elPanel=i.getNextSibling(p);if(i.hasClass(p,"alfresco-twister-closed")){i.removeClass(elPanel,"hidden");i.replaceClass(p,"alfresco-twister-closed","alfresco-twister-open")}else{i.addClass(elPanel,"hidden");i.replaceClass(p,"alfresco-twister-open","alfresco-twister-closed")}},renderProjectManager:function c(q){var r=q.getData("itemData")["assoc_pjt_projectManager"];var p="";if(r&&r[0]){p+='<div class="project-manager avatar" title="'+r[0].metadata+'">';p+=Alfresco.Share.userAvatar(r[0].displayValue,32);p+="</div>"}return p},renderTaskList:function n(s){var t=s.getData("itemData")["dt_pjt_taskList"];var r='<ul class="hidden">',p=0;for(j in t){var q=t[j];p++;r+="<li>"+this.getTaskTitle(q,s.getData().nodeRef,true)+"</li>"}r+="</ul>";return'<div ><a class="alfresco-twister alfresco-twister-closed '+a+'">'+this.msg("show.tasks")+"("+p+")</a>"+r+"</div>"},renderDeliverableList:function f(t){var q=t.getData("itemData")["dt_pjt_deliverableList"],p=0;var s='<ul class="hidden">';for(j in q){var r=q[j];p++;s+="<li>"+this.getDeliverableTitle(r,t.getData().nodeRef)+"</li>"}s+="</ul>";return'<div ><a class="alfresco-twister alfresco-twister-closed '+a+'">'+this.msg("show.deliverables")+"("+p+")</a>"+s+"</div>"},_showPanel:function m(r,s,q){var p=this;Alfresco.util.Ajax.request({url:r,dataObj:{htmlid:s},successCallback:{fn:function(t){var v=document.createElement("div");v.innerHTML=t.serverResponse.responseText;var u=i.getFirstChild(v);this.widgets.panel=Alfresco.util.createYUIPanel(u,{draggable:true,width:"50em"});this.widgets.panel.subscribe("hide",function(){p.reloadDataTable()});this.widgets.panel.show()},scope:this},failureMessage:"Could not load dialog template from '"+r+"'.",scope:this,execScripts:true})}});YAHOO.lang.augmentProto(beCPG.component.EntityProjects,beCPG.component.ProjectCommons)})();