(function(){beCPG.custom.NodeHeader=function b(f){beCPG.custom.NodeHeader.superclass.constructor.call(this,f);this.preferencesService=new Alfresco.service.Preferences();return this};YAHOO.extend(beCPG.custom.NodeHeader,Alfresco.component.NodeHeader,{onReady:function d(){var j=this;if(this.options.siteId!=this.options.actualSiteId){if(this.options.actualSiteId!=null){var f=window.location.href.replace(this.options.siteId,this.options.actualSiteId);Alfresco.util.PopupManager.displayPrompt({text:this.msg("message.document.moved",this.options.actualSiteId),buttons:[{text:this.msg("button.ok"),handler:function(){window.location=f},isDefault:true}]});YAHOO.lang.later(10000,this,function(){window.location=f})}else{var f="/share/page/entity-details?nodeRef="+this.options.nodeRef;Alfresco.util.PopupManager.displayPrompt({text:this.msg("message.document.movedToRepo"),buttons:[{text:this.msg("button.ok"),handler:function(){window.location=f},isDefault:true}]});YAHOO.lang.later(10000,this,function(){window.location=f})}return}this.nodeType="entity";if(!this.options.showOnlyLocation){if(this.options.showLikes){new Alfresco.Like(this.id+"-like").setOptions({nodeRef:this.options.nodeRef,siteId:this.options.siteId,type:this.nodeType,displayName:this.options.displayName,activity:{entity:{type:"org.alfresco.documentlibrary.entity-liked",page:"entity-details?nodeRef={nodeRef}"}}}).display(this.options.likes.isLiked,this.options.likes.totalLikes)}if(this.options.showFavourite){new Alfresco.Favourite(this.id+"-favourite").setOptions({nodeRef:this.options.nodeRef,type:"folder"}).display(this.options.isFavourite)}if(this.options.showQuickShare){new Alfresco.QuickShare(this.id+"-quickshare").setOptions({nodeRef:this.options.nodeRef,displayName:this.options.displayName}).display(this.options.sharedId,this.options.sharedBy)}Alfresco.util.useAsButton(this.id+"-print-button",function(l){var k=window.open(Alfresco.constants.URL_PAGECONTEXT+"print-details?nodeRef="+this.options.nodeRef);setTimeout(function(){k.print()},3000)},null,this);var h=Dom.get(this.id+"-modifyDate");h.innerHTML=Alfresco.util.formatDate(Alfresco.util.fromISO8601(h.innerHTML),Alfresco.util.message("date-format.default"));this.widgets.viewEntityDatalist=Alfresco.util.createYUIButton(j,"viewEntityDatalist-button",function(m,l,k){window.location.href=beCPG.util.entityCharactURL(j.options.siteId,j.options.nodeRef,j.options.itemType)});this.widgets.viewEntityDocuments=Alfresco.util.createYUIButton(j,"viewEntityDocuments-button",function(m,l,k){window.location.href=beCPG.util.entityDocumentsURL(j.options.siteId,j.options.path,j.options.itemName,true)});YAHOO.util.Event.addListener(j.id+"-uploadLogo-button","click",function(m){if(!j.fileUpload){j.fileUpload=Alfresco.getFileUploadInstance()}var k={flashUploadURL:"becpg/entity/uploadlogo",htmlUploadURL:"becpg/entity/uploadlogo.html",updateNodeRef:j.options.nodeRef,mode:j.fileUpload.MODE_SINGLE_UPLOAD,onFileUploadComplete:{fn:function l(n){var p=n.successful.length;if(p!=0){var o=n.successful[0].nodeRef;YAHOO.Bubbling.fire("metadataRefresh")}},scope:this}};j.fileUpload.show(k);YAHOO.util.Event.preventDefault(m)});if(this.options.report!==null){this.widgets.entityReportPicker=new YAHOO.widget.Button(j.id+"-entityReportPicker-button",{type:"split",menu:j.id+"-entityReportPicker-select",lazyloadmenu:false});this.widgets.entityReportPicker.on("click",j.onEntityReportPickerClicked,j,true);this.widgets.entityReportPicker.getMenu().subscribe("click",function(l,k){var m=k[1];if(m){j.widgets.entityReportPicker.set("label",m.cfg.getProperty("text"));j.onEntityReportPickerClicked.call(j,m)}});if(this.options.report.isSelected){var i=j.widgets.entityReportPicker.getMenu().getItems();for(var g in i){if(i.hasOwnProperty(g)){if(i[g].value===this.options.report.nodeRef){j.widgets.entityReportPicker.set("label",i[g].cfg.getProperty("text"));j.onEntityReportPickerClicked.call(j,i[g]);break}}}}this.widgets.downloadEntityReport=Alfresco.util.createYUIButton(j,"downloadEntityReport-button",function(m,l,k){window.location.href=Alfresco.constants.PROXY_URI+j.options.report.contentURL+"&a=true&noCache="+new Date().getTime()})}}if(this.options.report===null||!this.options.report.isSelected){Dom.removeClass("properties-tab","hidden");Dom.addClass("preview-tab","hidden")}},doRefresh:function e(){YAHOO.Bubbling.unsubscribe("metadataRefresh",this.doRefresh,this);var f="components/entity-details/entity-header?nodeRef={nodeRef}&rootPage={rootPage}&rootLabelId={rootLabelId}&showFavourite={showFavourite}&showLikes={showLikes}&showComments={showComments}&showQuickShare={showQuickShare}&showDownload={showDownload}&showPath={showPath}"+(this.options.pagecontext?"&pagecontext={pagecontext}":"")+(this.options.libraryRoot?"&libraryRoot={libraryRoot}":"")+(this.options.siteId?"&site={siteId}":"");this.refresh(f)},onEntityReportPickerClicked:function a(g){var f=this;if(g){f.widgets.entityReportPicker.value=encodeURIComponent(g.value);f.preferencesService.set(f.getPickerPreference(),g.cfg.getProperty("text"),{successCallback:{fn:function(){if("properties"===f.widgets.entityReportPicker.value){Dom.removeClass("properties-tab","hidden");Dom.addClass("preview-tab","hidden")}else{if(encodeURIComponent(f.options.report.nodeRef)!=f.widgets.entityReportPicker.value){window.location.href=window.location.href.split("#")[0]}Dom.addClass("properties-tab","hidden");Dom.removeClass("preview-tab","hidden")}},scope:this}})}},getPickerPreference:function c(){return"fr.becpg.repo.report."+this.options.itemType.replace(":","_")+".view"}})})();