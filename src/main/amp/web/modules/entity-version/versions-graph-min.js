(function(){var f=YAHOO.util.Dom,b=YAHOO.util.KeyListener;var e=Alfresco.util.encodeHTML,o=Alfresco.Share.userAvatar;beCPG.module.VersionsGraph=function(q){this.name="beCPG.module.VersionsGraph";this.id=q;var p=Alfresco.util.ComponentManager.get(this.id);if(p!==null){throw new Error("An instance of beCPG.module.VersionsGraph already exists.")}Alfresco.util.ComponentManager.register(this);Alfresco.util.YUILoaderHelper.require(["datasource","datatable","button","container"],this.onComponentsLoaded,this);return this};beCPG.module.VersionsGraph.prototype={options:{nodeRef:null,},graphData:[],colors:[[1,0,0],[1,1,0],[0,1,0],[0,1,1],[0,0,1],[1,0,1],[1,1,0],[0,0,0]],line_width:2,dot_radius:5,widgets:{},onComponentsLoaded:function d(){if(this.id===null){return}},show:function l(p){this.options=YAHOO.lang.merge(this.options,p);if(this.options.nodeRef===undefined){throw new Error("A nodeRef, must be provided")}if(this.widgets.panel){this.update();this._showPanel()}else{Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"modules/entity-version/versions-graph?htmlid="+this.id,successCallback:{fn:this.onTemplateLoaded,scope:this},failureMessage:"Could not load html template for version graph",execScripts:true});this.widgets.escapeListener=new b(document,{keys:b.KEY.ESCAPE},{fn:this.onCancelButtonClick,scope:this,correctScope:true})}},onTemplateLoaded:function h(p){var r=document.createElement("div");r.innerHTML=p.serverResponse.responseText;var q=YAHOO.util.Dom.getFirstChild(r);this.widgets.panel=Alfresco.util.createYUIPanel(q);this.update();this._showPanel()},onCancelButtonClick:function k(){this.widgets.panel.hide();this.widgets.escapeListener.disable()},update:function a(){var p=this;this.widgets.alfrescoDataTable=new Alfresco.util.DataTable({dataSource:{url:Alfresco.constants.PROXY_URI+"becpg/api/entity-version?mode=graph&nodeRef="+this.options.nodeRef,doBeforeParseData:function(r,q){p.graphData=q;return({data:q})}},dataTable:{container:this.id+"-graphContent",columnDefinitions:[{key:"version",sortable:false,formatter:this.renderCellVersion},{key:"date",sortable:false,formatter:this.renderCellDate},{key:"author",sortable:false,formatter:this.renderCellAuthor}],config:{MSG_EMPTY:Alfresco.util.message("message.noVersions",this.name)}}});this.widgets.alfrescoDataTable.getDataTable().subscribe("postRenderEvent",function(){p.widgets.canvas=f.get(p.id+"-graphCanvas");if(window.G_vmlCanvasManager){p.widgets.canvas=window.G_vmlCanvasManager.initElement(p.widgets.canvas)}p.ctx=p.widgets.canvas.getContext("2d");p.ctx.strokeStyle="rgb(0, 0, 0)";p.ctx.fillStyle="rgb(0, 0, 0)";p.renderGraph(100)})},renderCellVersion:function j(r,q,u,v){var p="",t=q.getData(),s=(beCPG.module.getVersionsGraphInstance().options.nodeRef==t.entityNodeRef);p+='<div id="graph-version-row-'+this.getRecordIndex(q)+'" class="entity-branches">';p+='   <span class="document-version">'+e(t.label)+"</span>";p+='   <span class="'+t.metadata+(s?" current":"")+'" ><a href="'+beCPG.util.entityCharactURL(t.siteId,t.nodeRef,t.itemType)+'">'+e(t.name)+"</a></span>";p+='<div class="version-details">';p+=((t.description||"").length>0)?e(t.description,true):'<span class="faded">('+Alfresco.util.message("label.noComment",beCPG.module.getVersionsGraphInstance().name)+")</span>";p+="</div>";p+="</div>";r.innerHTML=p},renderCellAuthor:function c(s,r,u,v){var p="",t=r.getData();var q=Alfresco.util.uriTemplate("userprofilepage",{userid:t.creator.userName});p+='<a href="'+q+'" title="'+e(t.creator.firstName+" "+t.creator.lastName)+'">'+o(t.creator.userName,32)+"</a>";s.innerHTML=p},renderCellDate:function i(q,p,s,t){var r=p.getData();q.innerHTML=Alfresco.util.relativeTime(Alfresco.util.fromISO8601(r.createdDateISO))},setColor:function n(t,u,q){var r=t%this.colors.length;var y=(this.colors[r][0]*q)||u;var w=(this.colors[r][1]*q)||u;var p=(this.colors[r][2]*q)||u;y=Math.round(y*255);w=Math.round(w*255);p=Math.round(p*255);var v="rgb("+y+", "+w+", "+p+")";this.ctx.strokeStyle=v;this.ctx.fillStyle=v},renderGraph:function m(J){this.graphData.reverse();var C=0,D={},L=false,q={};for(var G in this.graphData){var z=this.graphData[G].entityNodeRef,y=this.graphData[G].entityFromBranch;var I=D[z];if(!I&&I!=0){if(y){for(var F in D){if(D[F]>D[y]){D[F]=D[F]+1}}D[this.graphData[G].entityNodeRef]=D[y]+1}else{D[this.graphData[G].entityNodeRef]=C}C++}}var M=this.dot_radius+2;var E=Math.min(18,Math.floor((J-M*2)/(C)));var B=J-M-10;var p={},r=15;C=0;var A=this.graphData.length-1;var v=f.getY(this.id+"-graphNodes")-r;for(var G in this.graphData){var K=f.getY("graph-version-row-"+(A-1))-v;var O=f.getY("graph-version-row-"+(A))-v;var z=this.graphData[G].entityNodeRef,y=this.graphData[G].entityFromBranch;var I=q[z];if(!I&&I!=0){q[z]=C++;L=true}for(var F in q){var s=D[F],w=(L&&F==z&&y!=null)?y:F,u=D[w];this.setColor(s,0,0.65);x=B-E*u;this.ctx.lineWidth=this.line_width;this.ctx.beginPath();if(u!=s){var t=f.getY("graph-version-row-"+(p[w]))-v-this.dot_radius;this.ctx.moveTo(x,t);var H=B-E*s;var N=(O+t)/2;this.ctx.bezierCurveTo(x,N,H,N,H,O);this.ctx.moveTo(H,O);this.ctx.lineTo(H,K,3)}else{this.ctx.moveTo(x,O);this.ctx.lineTo(x,K,3)}this.ctx.stroke()}L=false;radius=this.dot_radius;x=B-E*D[z];p[z]=A;this.ctx.beginPath();this.setColor(D[z],0.25,0.75);this.ctx.arc(x,O,radius,0,Math.PI*2,true);this.ctx.fill();A--}},_showPanel:function g(){this.widgets.escapeListener.enable();this.widgets.panel.show()}}})();beCPG.module.getVersionsGraphInstance=function(){var a="becpg-versionsGraph-instance";return Alfresco.util.ComponentManager.get(a)||new beCPG.module.VersionsGraph(a)};