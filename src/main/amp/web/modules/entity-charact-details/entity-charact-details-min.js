(function(){YAHOO.widget.Chart.SWFURL=Alfresco.constants.URL_CONTEXT+"res/yui/charts/assets/charts.swf";var f="beCPG.module.EntityCharactDetails",m="chartType";beCPG.module.EntityCharactDetails=function(n){this.id=n;beCPG.module.EntityCharactDetails.superclass.constructor.call(this,"beCPG.module.EntityCharactDetails",n,["button","container","menu","datasource"]);this.preferencesService=new Alfresco.service.Preferences()};YAHOO.extend(beCPG.module.EntityCharactDetails,Alfresco.component.Base,{dataSource:null,options:{entityNodeRef:null,itemType:null,dataListItems:null,dataListName:null},onChartTypeSelected:function d(o){var n=this;if(o){n.widgets.chartTypePicker.value=o.value;n.preferencesService.set(n.getPreference(m),n.widgets.chartTypePicker.value,{successCallback:{fn:n.render(),scope:this}})}},getPreference:function j(n){return f+(this.options.itemType?"."+this.options.itemType:"")+(n?"."+n:"")},onChartTypeClicked:function c(n){this.render()},onReady:function g(){var n=this;this.widgets.chartTypePicker=new YAHOO.widget.Button(n.id+"-chartTypePicker-button",{type:"split",menu:n.id+"-chartTypePicker-select",lazyloadmenu:false});this.widgets.chartTypePicker.on("click",n.onChartTypeClicked,n,true);this.widgets.chartTypePicker.getMenu().subscribe("click",function(p,o){var q=o[1];if(q){n.widgets.chartTypePicker.set("label",q.cfg.getProperty("text"));n.onChartTypeSelected.call(n,q)}});this.widgets.exportCSVButton=Alfresco.util.createYUIButton(this,"export-csv",this.onExportCSV,{disabled:false,value:"export"});n.selectMenuValue(n.widgets.chartTypePicker,"barChart");this.preferencesService.request(n.getPreference(),{successCallback:{fn:function(p){var o=Alfresco.util.findValueByDotNotation(p.json,n.getPreference(m),null);if(o!==null){n.selectMenuValue(n.widgets.chartTypePicker,o)}},scope:this}});n.loadChartData()},onExportCSV:function k(){if(this.options.entityNodeRef!=null&&this.options.entityNodeRef.length>0){window.location=this._buildDetailsUrl("csv")}},selectMenuValue:function b(n,p){n.value=p;var o=n.getMenu().getItems();for(index in o){if(o.hasOwnProperty(index)){if(o[index].value===p){n.set("label",o[index].cfg.getProperty("text"));break}}}},loadChartData:function a(){if(this.options.entityNodeRef!=null&&this.options.entityNodeRef.length>0){Alfresco.util.Ajax.request({url:this._buildDetailsUrl("json"),successCallback:{fn:this.processData,scope:this},failureCallback:{fn:function(){},scope:this}})}},_buildDetailsUrl:function h(n){return Alfresco.constants.PROXY_URI+"becpg/charact/formulate"+(n!=null&&n.length>0?"."+n:"")+"?entityNodeRef="+this.options.entityNodeRef+"&itemType="+this.options.itemType+"&dataListName="+this.options.dataListName+"&dataListItems="+this.options.dataListItems},processData:function l(n){var p=n.json;var o=[];this.columnDefs=[];this.seriesDef=[];this.barChartSeriesDef=[];for(i in p.metadatas){o.push({key:"col"+i,parser:function(r){if(!YAHOO.lang.isValue(r)||(r==="")){return null}var q=r*1;if(YAHOO.lang.isNumber(q)){return Math.floor(q*10000)/10000}return r}});this.columnDefs.push({key:"col"+i,label:p.metadatas[i].colName});if(i>0){this.seriesDef.push({displayName:p.metadatas[i].colName,yField:"col"+i});this.barChartSeriesDef.push({displayName:p.metadatas[i].colName,xField:"col"+i})}}this.dataSource=new YAHOO.util.DataSource(p.resultsets);this.dataSource.responseType=YAHOO.util.DataSource.TYPE_JSARRAY;this.dataSource.responseSchema={fields:o};this.render()},render:function e(){if(this.dataSource!=null){if(this.widgets.chartTypePicker.value=="lineChart"){new YAHOO.widget.LineChart(this.id+"-chart",this.dataSource,{series:this.seriesDef,xField:"col0",wmode:"opaque",style:{legend:{display:"bottom"}}})}else{if(this.widgets.chartTypePicker.value=="barChart"){new YAHOO.widget.BarChart(this.id+"-chart",this.dataSource,{series:this.barChartSeriesDef,yField:"col0",wmode:"opaque",style:{legend:{display:"bottom"}}})}else{if(this.widgets.chartTypePicker.value=="columnChart"){new YAHOO.widget.ColumnChart(this.id+"-chart",this.dataSource,{series:this.seriesDef,xField:"col0",wmode:"opaque",style:{legend:{display:"bottom"}}})}else{if(this.widgets.chartTypePicker.value=="pieChart"){new YAHOO.widget.PieChart(this.id+"-chart",this.dataSource,{dataField:"col1",categoryField:"col0",wmode:"opaque",style:{legend:{display:"right"}}})}else{if(this.widgets.chartTypePicker.value=="chartData"){new YAHOO.widget.DataTable(this.id+"-chart",this.columnDefs,this.dataSource)}}}}}}}})})();